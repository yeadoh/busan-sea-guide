name: Deploy to EC2 (BOSS Branch)

on:
  push:
    branches:
      - boss  # 'boss' 브랜치에 올릴 때만 작동합니다!

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Deploy to EC2 using SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST_IP }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          port: 22
          script: |
            REPO_DIR="/home/ec2-user/busan-sea-guide/"
            WEB_ROOT="/usr/share/nginx/html"

            echo "🚀 BOSS 브랜치 배포 시작!"

            # 1. 폴더가 없으면 Clone
            if [ ! -d "$REPO_DIR" ]; then
              echo "📂 프로젝트 폴더가 없어서 새로 받습니다..."
              git clone https://github.com/yeadoh/busan-sea-guide.git $REPO_DIR
            fi

            # 2. 폴더로 이동
            cd $REPO_DIR

            # ---------------------------------------------------
            # 👇 [수정 2] 여기가 핵심입니다! 브랜치를 갈아타야 해요.
            # ---------------------------------------------------
            echo "🔄 브랜치 전환 중: main -> boss"
            
            # 깃허브에 있는 최신 브랜치 정보들을 다 가져옵니다.
            git fetch --all
            
            # boss 브랜치로 전환합니다. (서버엔 처음일 테니 checkout으로 이동)
            git checkout boss
            
            # boss 브랜치의 최신 내용을 당겨옵니다.
            git pull origin boss
            
            # ---------------------------------------------------

            echo "🧹 기존 웹 파일 정리 & 덮어쓰기..."
            sudo rm -rf $WEB_ROOT/*
            sudo cp -r $REPO_DIR/* $WEB_ROOT/

            echo "✨ Nginx 재시작..."
            sudo systemctl restart nginx
            
            echo "✅ BOSS 브랜치 배포 완료!"